#+title:   elisp é…ç½®æ–‡ä»¶
#+author:  JanSky
#+date:    2025-07-10
#+STARTUP: overview indent


* åŸºç¡€é…ç½®
#+begin_src emacs-lisp
  (setq inhibit-startup-screen t)                                     ;; å…³é—­å¼€å§‹ç•Œé¢
  (setq-default display-line-numbers t)                               ;; æ˜¾ç¤ºè¡Œå·
  (setq display-line-numbers-width-start t)                           ;; åŠ¨æ€è°ƒæ•´è¡Œå·å®½åº¦
  (setq display-line-numbers-grow-only t)                             ;; è¡Œå·å®½åº¦åªå¢ä¸å‡ï¼ˆå‡å°‘æŠ–åŠ¨ï¼‰
  (tool-bar-mode -1)                                                  ;; å…³é—­å·¥å…·æ 
  (menu-bar-mode -1)                                                  ;; å…³é—­èœå•æ 
  (setq-default cursor-type 'bar)                                     ;; æ›´æ”¹å…‰æ ‡æ ·å¼
  (global-hl-line-mode t)                                             ;; é«˜äº®å½“å‰è¡Œ
  (scroll-bar-mode -1)                                                ;; å…³é—­æ–‡ä»¶æ»‘åŠ¨æ§ä»¶
  (show-paren-mode t)                                                 ;; æ‹¬å·åŒ¹é…
  (electric-pair-mode 1)                                              ;; æ‹¬å·è¡¥å…¨
  (add-hook 'prog-mode-hook 'prettify-symbols-mode)                   ;; ä¼šå°† lambda ç­‰ç¬¦å·ç¾åŒ–ä¸º Î»
  (set-face-attribute 'default nil :font "Sarasa Term SC Nerd 12")    ;; è®¾ç½®å­—ä½“
  (setq make-backup-files nil)                                        ;; å…³é—­è‡ªåŠ¨å¤‡ä»½
  (delete-selection-mode 1)                                           ;; å…¨é€‰åŠ å¼º
  (setq ring-bell-function 'ignore)                                   ;; å…³æ‰å“”å“”å£°
  (fset 'yes-or-no-p 'y-or-n-p)                                       ;; å¿«é€Ÿ yes æˆ– no
  (setq-default indent-tabs-mode nil)                                 ;; å¯ç”¨ tab é”®
  (setq default-frame-alist '((width . 130) (height . 40)))           ;; è®¾ç½®çª—å£å¤§å°
  (setq-default truncate-lines t)                                     ;; ç¦ç”¨å•è¡Œè¿‡é•¿æ—¶è‡ªåŠ¨æ¢è¡Œ
  (setq scroll-preserve-screen-position t)                            ;; ä¿æŒå…‰æ ‡åœ¨å±å¹•çš„ç»å¯¹ä½ç½®
  (setq isearch-allow-scroll t)                                       ;; æœç´¢åŠŸèƒ½åŠ å¼º
  (setq pixel-scroll-precision-mode t)

  (add-hook 'help-fns-describe-function-functions                     ;; æ˜¾ç¤ºä»£ç ç¤ºä¾‹
            #'shortdoc-help-fns-examples-function)
#+end_src

* æ’ä»¶æºé…ç½®
#+begin_src emacs-lisp
  (use-package package
    :config
    (setq package-archives '(("melpa" . "https://melpa.org/packages/")))
    (setq package-check-signature nil)
    (package-initialize))
#+end_src

* modeline é…ç½®
#+begin_src emacs-lisp
  (size-indication-mode t)                                            ;; æ˜¾ç¤ºæ–‡ä»¶å¤§å°
  (line-number-mode -1)                                               ;; å…³é—­è¡Œå·æ˜¾ç¤º
  (column-number-mode t)                                              ;; æ˜¾ç¤ºå½“å‰åˆ—
  (setq mode-line-in-non-selected-windows nil)                        ;; ç»Ÿä¸€ modeline æ˜¾ç¤º
  (setq column-number-indicator-zero-based nil)                       ;; åˆ—ä» 1 å¼€å§‹è®¡æ•°
  (setq display-time-format "ğŸ“†%Yå¹´%mæœˆ%dæ—¥ â°%H:%M")                ;; æ—¥æœŸæ ¼å¼
  (setq display-time-default-load-average nil)                        ;; ä¸ç°å®è´Ÿè½½
  (setq battery-mode-line-format "ğŸ”‹%p%% âš¡%rç“¦")                    ;; ç”µæ± æ ¼å¼
  (setq battery-update-interval 1)                                    ;; ç”µæ± æ›´æ–°å¹³ç‡ä¸º 1 ç§’
  (display-time-mode 1)                                               ;; æ˜¾ç¤ºæ—¶é—´
  (display-battery-mode 1)                                            ;; æ˜¾ç¤ºç”µæ± 
#+end_src

* minibuffer é…ç½®
#+begin_src emacs-lisp
  (minibuffer-electric-default-mode 1)                                ;; minibuffer å¢å¼ºåŠŸèƒ½
  (fido-vertical-mode 1)                                              ;; å‚ç›´è¡¥å…¨
  (setq completion-auto-help nil)                                     ;; æŒ‰ TAB ä¸æ˜¾ç¤ºè¡¥å…¨åˆ—è¡¨ç¼“å†²åŒº
#+end_src

* ä¸»é¢˜é…ç½®
** åŸºç¡€é…è‰²
#+begin_src emacs-lisp
  (use-package catppuccin-theme
    :ensure t
    :config
    (setq catppuccin-flavor 'mocha)
    (load-theme 'catppuccin t))
#+end_src
** å½©è™¹æ‹¬å·
#+begin_src elisp
  (use-package rainbow-delimiters
    :ensure t
    :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

* tree-sitter é…ç½®
** åŸºç¡€é…ç½®
#+begin_src emacs-lisp
  (use-package treesit
    :config
    (setq treesit-workdir (expand-file-name "~/.emacs.d/tree-sitter/"))
    (setq treesit-language-source-alist
          '((c . ("https://github.com/tree-sitter/tree-sitter-c"))
            (cpp . ("https://github.com/tree-sitter/tree-sitter-cpp"))
            (toml . ("https://github.com/tree-sitter/tree-sitter-toml"))
            (html . ("https://github.com/tree-sitter/tree-sitter-html"))))
    (setq major-mode-remap-alist
          '((c-mode . c-ts-mode)
            (c++-mode . c++-ts-mode)
            (mhtml-mode . html-ts-mode)
            (conf-toml-mode . toml-ts-mode)))
    (setq treesit-font-lock-level 4))
#+end_src

* lsp é…ç½®
** åŸºç¡€é…ç½®
#+begin_src emacs-lisp
  (use-package eglot
    :config
    (add-to-list 'eglot-server-programs '((c++-ts-mode c-ts-mode) "clangd"))
    :hook
    (c++-ts-mode . eglot-ensure)
    (c-ts-mode . eglot-ensure))

  (setq c-ts-mode-indent-offset 4)
#+end_src
** æ–‡æ¡£æŸ¥çœ‹
#+begin_src elisp
  (add-hook 'special-mode-hook
            (lambda ()
              (display-line-numbers-mode -1)))         ;; ä¸æ˜¾ç¤ºè¡Œå·
#+end_src

* org é…ç½®
** åŸºç¡€é…ç½®
#+begin_src emacs-lisp
  (org-babel-do-load-languages          ; org ä¸­å¿«é€Ÿè¿è¡Œä»£ç 
   'org-babel-load-languages
   '((python . t)
     (C . t)))
  (setq org-startup-with-latex-preview t)
  (setq org-startup-numerated t)        ; åœ¨ org æ ‡é¢˜ä¸­æ·»åŠ åºå·
  (setq org-hide-emphasis-markers t)    ; è‡ªåŠ¨éšè—æ ‡è®°ç¬¦å·
#+end_src
** ç¼–è¾‘ä¸å¯è§éƒ¨åˆ†
#+begin_src elisp
  (use-package org-appear
    :ensure t
    :hook (org-mode . org-appear-mode)
    :config
    (setq org-appear-autostart t)
    (setq org-appear-autoemphasis t)
    (setq org-appear-autolinks t)
    (setq org-appear-autoentities t)
    (setq org-appear-autokeywords t)
    (setq org-appear-autosubmarkers t))
#+end_src

* æ–‡ä»¶é…ç½®
** recentf é…ç½®
#+begin_src emacs-lisp
  (use-package recentf
    :init (recentf-mode 1)
    :hook (emacs-startup . recentf-open-files)
    :config
    (global-set-key (kbd "<f1>") 'recentf-open-files)
    (setq recentf-max-menu-item 20)) 
#+end_src
** dired-x é…ç½®
#+begin_src elisp
  (use-package dired-x
    :after dired
    :config (setq dired-x-hands-off-my-keys nil))
#+end_src

* eshell é…ç½®
** åŸºç¡€é…ç½®
#+begin_src emacs-lisp
  (setq eshell-banner-message "")                      ;; å–æ¶ˆ eshell å¯åŠ¨é—®å€™

  (add-hook 'eshell-mode-hook
            (lambda ()
              (shell-command "fcitx5-remote -c")       ;; å…³é—­è¾“å…¥æ³•
              (setq display-line-numbers nil)))         ;; ä¸æ˜¾ç¤ºè¡Œå·

  (defun kill-eshell-buf ()
    "æ€æ­» eshell"
    (let ((buf "*eshell*"))
      (kill-buffer buf)
      (delete-window (get-buffer-window buf))))

  (defun my-eshell-prompt ()
    "æ·±è‰²ä¸»é¢˜æœ€ä½³å¯è¯»æ€§æç¤ºç¬¦"
    (concat
     (propertize "ğŸ¦Š " 'face '(:foreground "#FF6B35"))                    ;; å›¾æ ‡ - äº®æ©™è‰²
     (propertize (user-login-name) 'face '(:foreground "#4ECDC4"))        ;; ç”¨æˆ·å - é’è‰²
     (propertize "@" 'face '(:foreground "#A0A0A0"))                      ;; åˆ†éš”ç¬¦ - æµ…ç°è‰²
     (propertize (file-name-nondirectory (eshell/pwd))                    ;; ç›®å½•å - äº®ç»¿è‰²
                 'face '(:foreground "#98CE00" :bold))
     (propertize " > " 'face '(:foreground "#FFD166"))))                  ;; ç»“å°¾ç¬¦å· - äº®é»„è‰²
  (setq eshell-prompt-function 'my-eshell-prompt)

  (defun eshell/em (file)
    "åœ¨ eshell ä¸­æ‰“å¼€æ–‡ä»¶"
    (other-window 1)
    (let ((path (eshell/pwd)))
      (find-file (expand-file-name file path))))
  #+end_src

** eshell å¿«é€Ÿè¿è¡Œä»£ç 
#+begin_src emacs-lisp
  (defun esh-coderun ()
    "å¿«é€Ÿæ‰§è¡Œä»£ç "
    (interactive)
    (if (get-buffer-window "*eshell*")                     ;; æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ˜¾ç¤º *eshell* ç¼“å†²åŒºçš„çª—å£
        (kill-eshell-buf)
      (let* ((file (buffer-name))                          ;; è·å–æ–‡ä»¶å
             (main (file-name-base))                       ;; è·å–ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å
             (cmd (format "clang %s -o %s" file main)))    ;; è®¾å®šå¥½éœ€è¦æ‰§è¡Œçš„å‘½ä»¤
        (toggle-eshell)                                    ;; æ‰“å¼€ eshell
        (insert cmd)                                       ;; æ’å…¥å‘½ä»¤
        (eshell-send-input))))                             ;; æ‰§è¡Œå‘½ä»¤
#+end_src
** æ‰“å¼€ eshell
#+begin_src elisp
  (defun toggle-eshell()
    (interactive)
    (if (get-buffer-window "*eshell*")                   ;; æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ˜¾ç¤º *eshell* ç¼“å†²åŒºçš„çª—å£
        (kill-eshell-buf)                                ;; å…³é—­çª—å£
      (let ((win (split-window-below 30)))               ;; å¦åˆ™ï¼Œåœ¨åº•éƒ¨æ–°å»ºä¸€ä¸ªçª—å£,é«˜åº¦è‡ªå®šä¹‰
        (select-window win)                              ;; ç„¦ç‚¹åˆ‡æ¢åˆ°è¿™ä¸ªçª—å£
        (eshell))))                                      ;; è¿è¡Œ eshell
#+end_src

* é‚®ä»¶é…ç½®
#+begin_src elisp
  (require 'auth-source)
  (setq auth-sources '("~/.authinfo" "~/.authinfo.gpg"))    ;; æˆæƒç 
  (setq message-send-mail-function 'smtpmail-send-it)       ;; å‘é€é‚®ä»¶ä½¿ç”¨çš„å‡½æ•°
  (setq user-mail-address "1102812928@qq.com")              ;; è®¾ç½®é‚®ç®±åœ°å€
  (setq user-full-name "JanSky")                            ;; è®¾ç½®é‚®ç®±ç”¨æˆ·å
  (setq smtpmail-smtp-user "1102812928@qq.com"              ;; è®¾ç½®é‚®ç®±ç”¨æˆ·
        smtpmail-smtp-server "smtp.qq.com"                  ;; è®¾ç½®æœåŠ¡
        smtpmail-smtp-service 465                           ;; è®¾ç½®ç«¯å£
        smtpmail-stream-type 'ssl)                          ;; è®¾ç½®å®‰å…¨æœåŠ¡
  (setq smtpmail-debug-info t)                              ;; åŸºç¡€è°ƒè¯•ä¿¡æ¯
  (setq smtpmail-debug-verb t)                              ;; è¯¦ç»†è°ƒè¯•ä¿¡æ¯
  (setq message-kill-buffer-on-exit t)                      ;; å‘é€ååˆ é™¤ç¼“å†²åŒº
  (setq message-signature "ä½ è¯ºå®‰å¥½ï¼Œä¾¿æ˜¯æ™´å¤©")             ;; è‡ªå¸¦æ·»åŠ ç­¾å

  (setq gnus-select-method
        '(nnimap "qq"
                 (nnimap-address "imap.qq.com")
                 (nnimap-server-port 993)
                 (nnimap-stream ssl)
                 (nnimap-authinfo-file "~/.authinfo")))
#+end_src

* æ‚é¡¹åŠŸèƒ½
** é€šç”¨å‡½æ•°
#+begin_src elisp

#+end_src
** ASCII ç è¡¨å±•ç¤º
#+begin_src emacs-lisp
  (defun ascii()
    "å±•ç¤ºasciiç è¡¨"
    (interactive)
    (switch-to-buffer "*ASCII*")
    (erase-buffer)
    (setq buffer-read-only nil)        ;; Not need to edit the content, just read mode (added)
    (local-set-key "q" 'bury-buffer)   ;; Nice to have the option to bury the buffer (added)
    (setq lower32 '("nul" "soh" "stx" "etx" "eot" "enq" "ack" "bel"
  		          "bs" "ht" "nl" "vt" "np" "cr" "so" "si"
  		          "dle" "dc1" "dc2" "dc3" "dc4" "nak" "syn" "etb"
  		          "can" "em" "sub" "esc" "fs" "gs" "rs" "us"))
    (save-excursion (let ((i -1))
                      (insert "ASCII characters 0 thru 127.\n\n")
                      (insert " åå…­è¿›åˆ¶  åè¿›åˆ¶  å­—ç¬¦ |  åå…­è¿›åˆ¶  åè¿›åˆ¶  å­—ç¬¦ |  åå…­è¿›åˆ¶  åè¿›åˆ¶  å­—ç¬¦ | åå…­è¿›åˆ¶  åè¿›åˆ¶  å­—ç¬¦\n")
                      (while (< i 31)
                        (insert (format " %4x      %4d    %4s | %4x      %4d    %4s  | %4x      %4d    %4s  |  %4x     %4d  %4s \n"
                                        (setq i (+ 1  i)) i (elt lower32 i)
                                        (setq i (+ 32 i)) i (single-key-description i)
                                        (setq i (+ 32 i)) i (single-key-description i)
                                        (setq i (+ 32 i)) i (single-key-description i)))
                        (setq i (- i 96))))))
#+end_src

** å¿«é€Ÿæ‰“å¼€é…ç½®æ–‡ä»¶
#+begin_src emacs-lisp
  (defun open-file-config()
    "æ‰“å¼€é…ç½®æ–‡ä»¶"
    (interactive)
    (let ((buffer (buffer-name)))
      (if (string= buffer "emacs.org")
          (kill-buffer buffer)
        (find-file "~/.emacs.d/emacs.org"))))
#+end_src

** ç½‘ç»œè°ƒè¯•åŠ©æ‰‹
#+begin_src elisp
  (defvar server-process nil
    "ä¿å­˜æœåŠ¡å™¨è¿›ç¨‹çš„å˜é‡")

  (defun tcp-server-filter (process string)
    "tcp å¤„ç†æ¶ˆæ¯"
    (message "æ”¶åˆ°æ¶ˆæ¯: %s" string)
    (process-send-string process (format "æœåŠ¡å™¨æ”¶åˆ°")))

  (defun udp-server-filter (process string)
    "udp å¤„ç†æ¶ˆæ¯"
    (message "æ”¶åˆ°æ¶ˆæ¯: %s" string)
    (process-send-string process  "æœåŠ¡å™¨æ”¶åˆ°\0"))

  (defun server-sentinel (process event)
    "å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–"
    (message "è¿æ¥çŠ¶æ€: %s %s" (process-name process) event))

  (defun tcp-server ()
    "åœ¨æŒ‡å®šç«¯å£å¯åŠ¨ TCP æœåŠ¡å™¨"
    (interactive )
    (if (null server-process)
        (progn
          (setq server-process
                (make-network-process
                 :name "tcp-server"                 ;; è¿›ç¨‹çš„åå­—
                 :service 8080                      ;; ç«¯å£å·
                 :host "127.0.0.1"                  ;; ip åœ°å€
                 :server t                          ;; åˆ›å»ºæœåŠ¡å™¨è¿›ç¨‹
                 :family 'ipv4                      ;; æ˜¯ç”¨ ipv4
                 :noquery t                         ;; Emacs é€€å‡ºæ—¶è‡ªåŠ¨ç»ˆæ­¢è¿›ç¨‹
                 :filter 'tcp-server-filter         ;; å¤„ç†æ¶ˆæ¯
                 :sentinel 'server-sentinel))       ;; å¤„ç†è¿æ¥çŠ¶æ€
                (message "TCP æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ç«¯å£ %d" 8080))
      (progn (delete-process server-process)
             (setq server-process nil)
             (message "TCP æœåŠ¡å™¨å·²åœæ­¢"))))

  (defun udp-server ()
    "åœ¨æŒ‡å®šç«¯å£å¯åŠ¨ UDP æœåŠ¡å™¨"
    (interactive )
    (if (null server-process)
        (progn
          (setq server-process
                (make-network-process
                 :name "udp-server"                 ;; è¿›ç¨‹çš„åå­—
                 :service 8080                      ;; ç«¯å£å·
                 :host "127.0.0.1"                  ;; ip åœ°å€
                 :family 'ipv4                      ;; æ˜¯ç”¨ ipv4
                 :server t                          ;; åˆ›å»ºæœåŠ¡å™¨è¿›ç¨‹
                 :type 'datagram                    ;; UDP åè®®
                 :noquery t                         ;; Emacs é€€å‡ºæ—¶è‡ªåŠ¨ç»ˆæ­¢è¿›ç¨‹
                 :filter 'udp-server-filter))       ;; å¤„ç†æ¶ˆæ¯
                (message "UDP æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ç«¯å£ %d" 8080))
      (progn (delete-process server-process)
             (setq server-process nil)
             (message "UDP æœåŠ¡å™¨å·²åœæ­¢"))))
#+end_src
** å…³é—­å½“å‰ç¼“å†²åŒº
#+begin_src elisp
  (defun kill-current-buffer ()
    "å…³é—­å½“å‰ç¼“å†²åŒº"
    (interactive)
    (kill-buffer (current-buffer)))
#+end_src

* å¿«æ·é”®æç¤º
** åŸºç¡€è®¾ç½®
#+begin_src emacs-lisp
  (use-package which-key
    :init
    (define-key global-map (kbd "<f2>") '("æ‰“å¼€ Eshell" . toggle-eshell))
    (define-key global-map (kbd "<f3>") '("æ‰“å¼€é…ç½®æ–‡ä»¶" . open-file-config))
    (define-key global-map (kbd "<f5>") '("å¿«é€Ÿè¿è¡Œä»£ç " . esh-coderun))
    (define-key global-map (kbd "C-x c") '("å…³é—­å½“å‰ç¼“å†²åŒº" . kill-current-buffer))
    :config (which-key-mode 1))
#+end_src
